<?php include "includes/init.php"?>
<?php
//Creating token for the client who accessed the page
if (!isset($_SESSION['token_code'])) {
  // NEEDTO: Change message if a person tries to access this page without passing index.php
  set_msg("Please choose what you want to do");
  redirect('index.php');
}
// echo implode("\t|\t",$_SESSION);
?>

<!DOCTYPE html>
<html lang="en-US">
<!-- Adding the HEADER file -->
<?php include "includes/header_map.php" ?>

<body>
  <!-- ###############  Div that contains the header ############### -->
  <div id="header" class="col-md-12">
    <p class="text-center">eimg Lisbon - Demo Version </p>
  </div>

  <!-- ###############  Div that contains the sidebar ############### -->
  <div id="sidebar" class="sidebar collapsed">
    <!-- Nav tabs -->
    <div class="sidebar-tabs">
      <ul role="tablist">
        <!-- Icons from Font Awesome: https://fontawesome.com/cheatsheet?from=io -->
        <li><a href="#home" role="tab"><i class="fa fa-home"></i></a></li>
        <!-- fas: solid icon; far: regular icon; fal: light icon  -->
        <li><a href="#placeL1" role="tab" class="sidebar_tab_icon_liked"><i class="fa fa-check-circle"></i></a></li>
        <li><a href="#placeL2" role="tab" class="sidebar_tab_icon_liked"><i class="fa fa-check-circle"></i></a></li>
        <li><a href="#placeL3" role="tab" class="sidebar_tab_icon_liked"><i class="fa fa-plus"></i></a></li>
        <li><a href="#placeL4" role="tab" class="sidebar_tab_icon_liked"><i class="fa fa-thumbs-up"></i></a></li>
        <hr />
        <li><a href="#placeD1" role="tab" class="sidebar_tab_icon_disliked"><i class="fa fa-times-circle"></i></a></li>
        <li><a href="#placeD2" role="tab" class="sidebar_tab_icon_disliked"><i class="fa fa-times-circle"></i></a></li>
        <li><a href="#placeD3" role="tab" class="sidebar_tab_icon_disliked"><i class="fa fa-plus-circle"></i></a></li>
        <li><a href="#placeD4" role="tab" class="sidebar_tab_icon_disliked"><i class="fa fa-thumbs-down"></i></a></li>
      </ul>
      <ul role="tablist">
        <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
      </ul>
    </div> <!-- close DIV class="sidebar-tabs"> -->

    <!-- Tab panes -->
    <div class="sidebar-content">
      <!-- #### Start the content for each one of the tabs #### -->
      <!-- sidebar_tab: HOME -->
      <div class="sidebar-pane" id="home">
        <h1 class="sidebar-header"> <!-- Header of the tab -->
           Home<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
        </h1>
        <div style="padding-top: 1vh;">
          <button id='btnLocate' class='btn btn-primary btn-block'>Locate</button>
          <button id="btnZoomToDJ" class='btn btn-primary btn-block'>Zoom To DJ Basin</button>
          <button id="btnTransparent" class='btn btn-primary btn-block'>Make Polygons Transparent</button>
        </div>
      </div> <!-- close DIV id="home"> -->

      <!-- sidebar_tab: SETTINGS -->
      <div class="sidebar-pane" id="settings">
        <h1 class="sidebar-header"> <!-- Header of the tab -->
           Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
        </h1>
        <!-- <div id="google_translate_element"></div> -->
        <!-- SOURCE for design the translate box  https://jsfiddle.net/solodev/0stLrpqg/ -->
        <div class="ct-topbar">
          <div class="container">
        	<ul class="list-unstyled list-inline ct-topbar__list">
        	  <li class="ct-language">Choose a Language <i class="fa fa-arrow-down"></i>
        		<ul class="list-unstyled ct-language__dropdown">
        		  <li><a href="#googtrans(en|pt)" class="lang-pt lang-select" data-lang="pt"><img src="/<?php  echo $root_directory?>/resources/images/flags/flag-pt-24x16px.png" alt="PORTUGAL"></a></li>
        		  <li><a href="#googtrans(en|en)" class="lang-us lang-select" data-lang="en"><img src="/<?php  echo $root_directory?>/resources/images/flags/flag-usa-24x16px.png" alt="USA"></a></li>
        		  <li><a href="#googtrans(en|es)" class="lang-es lang-select" data-lang="es"><img src="/<?php  echo $root_directory?>/resources/images/flags/flag-spain-24x16px.png" alt="SPAIN"></a></li>
        		  <li><a href="#googtrans(en|fr)" class="lang-fr lang-select" data-lang="fr"><img src="/<?php  echo $root_directory?>/resources/images/flags/flag-france-24x16px.png" alt="FRANCE"></a></li>
        		  <li><a href="#googtrans(en|de)" class="lang-de lang-select" data-lang="de"><img src="/<?php  echo $root_directory?>/resources/images/flags/flag-germany-24x16px.png" alt="GERMANY"></a></li>
        		</ul>
        	  </li>
        	</ul>
          </div>
        </div>

      </div> <!-- close DIV id="settings"> -->

    </div> <!-- close DIV class="sidebar-content"> -->
  </div><!-- close DIV id="sidebar"> -->

  <!-- ###############  Div that contains the map application ############### -->
  <div id="mapdiv" class="col-md-12"></div>

  <script>
  // Global Variables
  var mymap;
  var backgroundLayer;
  var jsn_draw;
  var lyrDraw;
  var ctlEasybutton;
  var mobileDevice = false;

  //Check if the app is being seen in a mobile device
  if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
    mobileDevice = true;
  };

  //Lock the screen of a mobile device in a landscape mode
  if(mobileDevice){
    if("orientation" in screen) {
      var orientation_str = screen.orientation.type;
      var orientation_array = orientation_str.split("-");
      if( orientation_array[0] == "portrait"){
        // NEEDTO: Show this message in a modal div
        alert("Change the orientation of the device to: landscape");
      }
    }
  }

  $(document).ready(function(){
    //  ********* Map Initialization ****************
    mymap = L.map('mapdiv', {center:[38.7090, -9.1380], zoom:14, attributionControl:false, zoomControl:false});
    //Plugin leaflet-sidebar-v2: https://github.com/nickpeihl/leaflet-sidebar-v2
    ctlSidebar = L.control.sidebar('sidebar').addTo(mymap);
    //attributionControl: The footer of the map
    ctlAttribute = L.control.attribution({position:'bottomright'}).addTo(mymap);
    ctlAttribute.addAttribution('OSM');
    ctlAttribute.addAttribution('&copy; <a href="http://mastergeotech.info">Master in Geospatial Technologies</a>');
    //Control scale
    ctlScale = L.control.scale({position:'bottomright', metric:true, imperial:false, maxWidth:200}).addTo(mymap);
    //Control Latitude and Longitude

    if (!mobileDevice){
      ctlMouseposition = L.control.mousePosition({position:'bottomright'}).addTo(mymap);
    }

    // Adds a control using the easy button plugin
    ctlEasybutton = L.easyButton('fa-circle', function(){
       alert("NEEDTO: Populate this button");
    }, 'NEEDTO: add a title here', {position:'topright'}).addTo(mymap);

    backgroundLayer = new L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png").addTo(mymap);

    // define drawtoolbar options. Leaflet PM
    var toolbarOptions = {
      position: 'topright', // toolbar position, options are 'topleft', 'topright', 'bottomleft', 'bottomright'
      drawMarker: false, // adds button to draw markers
      drawPolyline: false, // adds button to draw a polyline
      drawRectangle: false, // adds button to draw a rectangle
      drawPolygon: true, // adds button to draw a polygon
      drawCircle: false, // adds button to draw a cricle
      cutPolygon: false, // adds button to cut a hole in a polygon
      editMode: false, // adds button to toggle edit mode for all layers
      removalMode: true, // adds a button to remove layers
    };

    // add leaflet.pm controls to the map
    mymap.pm.addControls(toolbarOptions);

    var drawingOptions = {
      // snapping
      snappable: true,
      snapDistance: 10,
      // example events: 'mouseout', 'dblclick', 'contextmenu'
      // List: http://leafletjs.com/reference-1.2.0.html#interactive-layer-click
      finishOn: 'contextmenu',
    };

    // let polygons finish their shape on 'dblclick' or contextmenu
    mymap.pm.enableDraw('Poly', drawingOptions);
    mymap.pm.disableDraw('Poly');

    // listen to when a new layer is created
    mymap.on('pm:create', function(e) {

      lyrDraw = e.layer;

      jsn_draw=lyrDraw.toGeoJSON().geometry;
      var jsn_draw_str = JSON.stringify(jsn_draw);
      console.log("jsn_draw");
      console.log(jsn_draw);
      console.log("jsn_draw_str");
      console.log(jsn_draw_str);

      jsn_draw = {type:'MultiPolygon',coordinates:[lyrDraw.toGeoJSON().geometry.coordinates]};
      console.log(jsn_draw);
      console.log(JSON.stringify(jsn_draw));

      createQuestionaryPopUp();
    });

    //  ********* Events on Map *********
    mymap.on('mousemove', function(e){
      var str = "Latitude: "+e.latlng.lat.toFixed(5)+"  Longitude: "+e.latlng.lng.toFixed(5)+"  Zoom Level: "+mymap.getZoom();
      $("#map_coords").html(str);
    });
    mymap.on('click', function(e){
      // $("#divLog").text("Map Clicked... Random Number: "+(Math.floor(Math.random() * 100)).toString());
    });

    // Zoom control
    var ctlZoom = L.control.zoom({position:'bottomright'}).addTo(mymap);

  }); //END $(document).ready function


  //  ********* jQuery Functions *********
  $("div").on("click", '.open-button', function () {
    var text = $(this).attr("text");
    //console.log(text);
  });

  //  ********* JS Functions *********
  function createQuestionaryPopUp(){
    var strPopup = "";
    strPopup += '<div id="dlg_divFilterEvaluation" class="text-center">';
    strPopup +=   '<h5 class="text-center">Evaluation*: </h5>';
    strPopup +=   '<div class="text-left">';
    strPopup +=     '<input type="radio" id="dlg_radio_l" name="dlg_radio_eval" value="Liked"><label for="dlg_radio_l">Like</label><br />';
    strPopup +=     '<input type="radio" id="dlg_radio_d" name="dlg_radio_eval" value="Disliked"><label for="dlg_radio_d">Dislike</label><br />';
    strPopup +=   '</div>';
    strPopup += '</div>';
    strPopup += '<div id="dlg_divFilterAttributes" class="text-center">';
    strPopup +=   '<h5 class="text-center">Attributes*: </h5>';
    strPopup +=   '<div class="text-left">';
    strPopup +=     '<input type="checkbox" id="dlg_cbx_att_nat" class="dlg_cbx_fltAttributes" name="dlg_fltAttributes" value="att_nat">';
    strPopup +=     '<label for="dlg_cbx_att_nat">Naturalness</label><br />';
    strPopup +=     '<input type="checkbox" id="dlg_cbx_att_open" class="dlg_cbx_fltAttributes" name="dlg_fltAttributes" value="att_open">';
    strPopup +=     '<label for="dlg_cbx_att_open">Openness</label><br />';
    strPopup +=     '<input type="checkbox" id="dlg_cbx_att_order" class="dlg_cbx_fltAttributes" name="dlg_fltAttributes" value="att_order">';
    strPopup +=     '<label for="dlg_cbx_att_order">Order<br></label><br />';
    strPopup +=     '<input type="checkbox" id="dlg_cbx_att_upkeep" class="dlg_cbx_fltAttributes" name="dlg_fltAttributes" value="att_upkeep">';
    strPopup +=     '<label for="dlg_cbx_att_upkeep">Upkeep</label><br />';
    strPopup +=     '<input type="checkbox" id="dlg_cbx_att_hist" class="dlg_cbx_fltAttributes" name="dlg_fltAttributes" value="att_hist">';
    strPopup +=     '<label for="dlg_cbx_att_hist">Historical Significance</label><br />';
    strPopup +=   '</div>';
    strPopup += '</div>';
    strPopup += '<button id="btnSave" class="btn btn-primary open-button" onclick="savePlace(this)" >Save</button>';

    lyrDraw.bindPopup(strPopup);
    lyrDraw.openPopup();
  };

  function savePlace(elem){
    //input[type=checkbox].cbx_fltPlaces
    //strPopup +=     '<input type="checkbox" id="dlg_cbx_att_open" class="dlg_cbx_fltAttributes" name="dlg_fltAttributes" value="att_open">';
    var eval_str;
    var att_nat;
    var att_open;
    var att_ord;
    var att_up;
    var att_hist;
    var cntChecks = 0;

    //alert("Button clicked");
    //working
    alert(document.getElementById("dlg_cbx_att_nat").checked);
    alert( $(elem).attr('checked'));

    return null;
    //console.log( $('#dlg_cbx_att_nat').attr('checked'))

    // //
    // if( $('#dlg_radio_l').attr('checked') ){
    //   eval_str = "Liked";
    //   eval_nr = 1;
    // }else if( $('#dlg_radio_d').attr('checked') ){
    //   att_nat = "Disliked";
    //   eval_nr = 2;
    // }
    // // else{
    // //
    // //   alert("Please evaluate the place as Liked or Disliked");
    // //   return null;
    // // }
    //
    // if( $('#dlg_cbx_att_nat').attr('checked') ){
    //   att_nat = 1;
    //   cntChecks++;
    // } else { att_nat = 0; }
    // if( $('#dlg_cbx_att_open').attr('checked') ){
    //   att_open = 1;
    //   cntChecks++;
    // } else { att_open = 0; }
    // if( $('#dlg_cbx_att_order').attr('checked') ){
    //   att_ord = 1;
    //   cntChecks++;
    // } else { att_ord = 0; }
    // if( $('#dlg_cbx_att_upkeep').attr('checked') ){
    //   att_up = 1;
    //   cntChecks++;
    // } else { att_up = 0; }
    // if( $('#dlg_cbx_att_hist').attr('checked') ){
    //   att_hist = 1;
    //   cntChecks++;
    // } else { att_hist = 0; }
    //
    // if (cntChecks == 0){
    //   alert("Please select at least one attribute");
    //   return null;
    // }
    //

    eval_nr = Math.floor(Math.random() * 2) + 1;
    eval_str = "NA";
    att_nat = Math.floor(Math.random() * 2); //Integer, either 0 or 1
    att_open = Math.floor(Math.random() * 2);
    att_ord = Math.floor(Math.random() * 2);
    att_up = Math.floor(Math.random() * 2);
    att_hist = Math.floor(Math.random() * 2);

    console.log(
      eval_nr,
      eval_str,
      att_nat,
      att_open,
      att_ord,
      att_up,
      att_hist
    );

    $.ajax({
      url:'add_place.php',
      data:{tbl:'eimglx_areas_demo',
      geojson:JSON.stringify(jsn_draw),
      eval_nr: eval_nr,
      eval_str: eval_str,
      att_nat: att_nat,
      att_open: att_open,
      att_ord: att_ord,
      att_up: att_up,
      att_hist: att_hist
    },
    type:'POST',
    success:function(response){
      console.log(response);
      $("#divLog").text("Place added successfully...");
      lyrDraw.closePopup();
      lyrDraw.remove();
      refreshPlaces();

    },
    error:function(xhr, status, error){
      $("#divLog").text("Something went wront... "+error);
    }
  });
}


//  ********* Mobile Functions and Listeners *********
$( window ).on( "orientationchange", function( event ) {
  //Do things based on the orientation of the mobile device
  if(mobileDevice){
    if("orientation" in screen) {
      var orientation_array = (screen.orientation.type).split("-");
      if( orientation_array[0] == "portrait"){
        // NEEDTO: Show this message in a modal div
        alert("Change the orientation of the device to: landscape");
      }else{  //landscape mode
        //Reloads the page
        location.reload();
        console.log( orientation_array[0] );
      }
    }
  }
});

//  ********* Google Translate Functions *********
// usar 'class = "notranslate"' para n√£o traduzir o elemento
function googleTranslateElementInit() {
  console.log("Inline SVG tags are the DOM elements that don't have the 'indexOf' function and break with Google Translate");
  new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
}

function triggerHtmlEvent(element, eventName) {
  var event;
  if (document.createEvent) {
	event = document.createEvent('HTMLEvents');
	event.initEvent(eventName, true, true);
	element.dispatchEvent(event);
  } else {
	event = document.createEventObject();
	event.eventType = eventName;
	element.fireEvent('on' + event.eventType, event);
  }
}

jQuery('.lang-select').click(function() {
  var theLang = jQuery(this).attr('data-lang');
  jQuery('.goog-te-combo').val(theLang);

  //alert(jQuery(this).attr('href'));
  window.location = jQuery(this).attr('href');
  location.reload();
});
</script>


<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>
